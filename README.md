# BFHL Bill Extraction API

Spring Boot service that converts raw bill PDFs into a clean, structured JSON summary using OpenAI's GPT‑4.1 vision model. It downloads a bill from a public URL, renders pages as images, extracts line items per page, reconciles counts, and returns a single normalized response object.

---

## Features

- Accepts a **document URL** instead of file upload, so it works directly with cloud storage links
- Uses **robust PDF loading** with multiple fallback strategies to handle corrupted or large PDFs
- Dynamically adjusts **DPI and memory usage** based on file size for performance on huge documents
- Processes pages in **batches and parallel threads** to speed up extraction on multi‑page bills
- Calls **OpenAI GPT‑4.1 Vision** with a constrained JSON schema to get consistent, typed output
- Performs **post‑extraction validation and reconciliation** (e.g., total item count, duplicate pages)
- Simple **health check** endpoint for uptime monitoring

Compared to a basic "upload‑and‑OCR" API, this service focuses on reliability (retry & fallbacks), structured JSON, and end‑to‑end automation from URL → JSON with minimal client logic.

---

## Architecture

- **Framework**: Spring Boot (Java 17) REST API
- **PDF Processing**: Apache PDFBox for loading, rendering, and memory‑aware processing
- **AI Model**: OpenAI GPT‑4.1 Vision, called via HTTP with base64‑encoded PNGs
- **Async / Performance**: Fixed thread pool plus configurable batch size and DPI per file size
- **Config**: All secrets are injected via environment variables (`OPENAI_API_KEY`, `OPENAI_API_URL`)

---

## API Endpoints

### Health Check

- **URL**: `GET /health`
- **Description**: Simple probe to check if the service is running
- **Response**: `200 OK` with body: `"API is running"`

### Extract Bill Data

- **URL**: `POST /extract-bill-data`
- **Request body**:

```json
{
  "documentUrl": "https://your-storage/bills/sample_1.pdf"
}
```

- **Request fields**:
  - `documentUrl` (string, required): Public HTTP/HTTPS URL of the bill PDF

- **High‑level processing steps**:
  1. Download the PDF with retries and exponential backoff
  2. Load the PDF using up to three strategies (standard, temp‑file, memory‑only)
  3. Choose optimal DPI based on file size and render each page to PNG
  4. Group pages into batches, call GPT‑4.1 with page images plus a strict JSON prompt
  5. Merge batch responses into a single data object
  6. Reconcile total item count and adjust for "Bill Detail" vs "Final Bill" pages
  7. Wrap everything into a response with `is_success` status

---

## Response Format

### Success Response

```json
{
  "is_success": true,
  "token_usage": {
    "total_tokens": 4250,
    "input_tokens": 2100,
    "output_tokens": 2150
  },
  "data": {
    "pagewise_line_items": [
      {
        "page_no": "1",
        "page_type": "Bill Detail",
        "bill_items": [
          {
            "item_name": "Atorvastatin 10mg Tablets",
            "item_amount": 450.00,
            "item_rate": 45.00,
            "item_quantity": 10.0
          },
          {
            "item_name": "Amoxicillin 500mg Capsules",
            "item_amount": 120.00,
            "item_rate": 12.00,
            "item_quantity": 10.0
          }
        ]
      },
      {
        "page_no": "2",
        "page_type": "Final Bill",
        "bill_items": [
          {
            "item_name": "Metformin 500mg Tablets",
            "item_amount": 280.00,
            "item_rate": 28.00,
            "item_quantity": 10.0
          }
        ]
      }
    ],
    "total_item_count": 3
  }
}
```

### Field Descriptions

**Root Level:**
- `is_success` (boolean): `true` if HTTP status is 200 and response matches valid schema, else `false`
- `token_usage` (object): Cumulative token usage from all OpenAI LLM calls
- `data` (object): Extracted bill data and line items

**Token Usage:**
- `total_tokens` (integer): Total tokens consumed (input + output)
- `input_tokens` (integer): Tokens sent to GPT‑4.1
- `output_tokens` (integer): Tokens generated by GPT‑4.1

**Bill Data:**
- `pagewise_line_items` (array): Array of pages extracted from the bill
- `total_item_count` (integer): Total count of items across all pages

**Page Object:**
- `page_no` (string): Page number (e.g., "1", "2", "3")
- `page_type` (string): One of: `"Bill Detail"`, `"Final Bill"`, `"Pharmacy"`, or other page types
- `bill_items` (array): Array of line items on this page

**Bill Item Object:**
- `item_name` (string): Exact name/description as printed on the bill
- `item_amount` (float): Net amount per item after any discounts (as printed on the bill)
- `item_rate` (float): Unit price / rate as printed on the bill
- `item_quantity` (float): Quantity ordered / purchased

### Failure Response

```json
{
  "is_success": false,
  "token_usage": null,
  "data": null
}
```

If extraction fails, `is_success` is `false` and both `token_usage` and `data` are `null`.

---

## Environment & Configuration

All secrets and external URLs are provided via environment variables; `application.properties` only references them.

**Required variables:**
- `OPENAI_API_KEY` – OpenAI API key used for Bearer authentication
- `OPENAI_API_URL` – Chat/completions endpoint (defaults to `https://api.openai.com/v1/chat/completions`)

**Key Spring configuration (from `src/main/resources/application.properties`):**
- Port: `8080`
- Max upload/request size: `100MB`
- Async pool: core `4`, max `8`, queue capacity `100`
- Async request timeout: `180000 ms` (3 minutes)

---

## Running the Service

### 1. Set Environment Variables

**Windows (cmd):**
```cmd
set OPENAI_API_KEY=sk-...
set OPENAI_API_URL=https://api.openai.com/v1/chat/completions
```

**Linux/Mac (bash):**
```bash
export OPENAI_API_KEY=sk-...
export OPENAI_API_URL=https://api.openai.com/v1/chat/completions
```

### 2. Start the API

```bash
mvn spring-boot:run
```

### 3. Test Endpoints

**Health check:**
```bash
curl http://localhost:8080/health
```

**Bill extraction (Windows):**
```cmd
curl -X POST http://localhost:8080/extract-bill-data ^
  -H "Content-Type: application/json" ^
  -d "{\"documentUrl\": \"https://example.com/sample.pdf\"}"
```

**Bill extraction (Linux/Mac):**
```bash
curl -X POST http://localhost:8080/extract-bill-data \
  -H "Content-Type: application/json" \
  -d '{"documentUrl": "https://example.com/sample.pdf"}'
```

---

## How This API Differs From Typical Bill OCR APIs

| Aspect | Typical OCR Endpoint | This Bill Extraction API |
|--------|----------------------|--------------------------|
| **Input** | Raw file upload only | Public PDF URL (downloaded & retried by service) |
| **PDF Robustness** | Single load strategy, fails on corrupted/large PDFs | Three‑stage robust loader with memory‑aware fallbacks |
| **Page Processing** | One‑shot OCR, no batching | DPI tuning, batching, parallel threads for large bills |
| **AI Model** | Generic OCR text blocks | GPT‑4.1 Vision prompted to return strict, typed JSON |
| **Post‑Processing** | Little or no validation | Merges batches, reconciles totals, skips duplicate pages |
| **Config & Secrets** | Often hard‑coded or mixed in properties | All secrets injected via env vars (`OPENAI_API_KEY`, etc.) |
| **Response Schema** | Varies widely | Fixed, strict JSON with `is_success`, `token_usage`, `data` |
| **Token Tracking** | Not tracked | Full token usage reported per request |

---

## Project Structure

```
bill-extraction/
├── src/main/java/com/bfhl/billextraction/
│   ├── BillExtractionApplication.java
│   ├── controller/
│   │   └── BillExtractionController.java
│   ├── service/
│   │   └── BillExtractionService.java
│   ├── model/
│   │   ├── BillExtractionRequest.java
│   │   ├── BillExtractionResponse.java
│   │   ├── ExtractionData.java
│   │   ├── PageWiseLineItems.java
│   │   ├── BillItem.java
│   │   └── TokenUsage.java
│   └── config/
│       └── PdfProcessingConfig.java
├── src/main/resources/
│   └── application.properties
├── pom.xml
└── README.md
```

---

## Technology Stack

- **Java 17** – Modern Java runtime
- **Spring Boot 3.x** – REST API framework
- **Apache PDFBox** – PDF rendering and processing
- **OpenAI API** – GPT‑4.1 Vision for intelligent extraction
- **Lombok** – Reduce boilerplate (annotations, logging)
- **Maven** – Dependency management and build

---

## Key Dependencies (pom.xml)

```xml
<!-- Spring Boot -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<!-- PDF Processing -->
<dependency>
    <groupId>org.apache.pdfbox</groupId>
    <artifactId>pdfbox</artifactId>
</dependency>

<!-- Logging & Utilities -->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
</dependency>

<!-- JSON Processing -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>
```

---

## Example Request & Response

### Request

```bash
POST /extract-bill-data HTTP/1.1
Host: localhost:8080
Content-Type: application/json

{
  "documentUrl": "https://storage.example.com/bills/pharmacy_bill_001.pdf"
}
```

### Response (200 OK)

```json
{
  "is_success": true,
  "token_usage": {
    "total_tokens": 3850,
    "input_tokens": 1950,
    "output_tokens": 1900
  },
  "data": {
    "pagewise_line_items": [
      {
        "page_no": "1",
        "page_type": "Bill Detail",
        "bill_items": [
          {
            "item_name": "Aspirin 500mg",
            "item_amount": 150.00,
            "item_rate": 15.00,
            "item_quantity": 10.0
          },
          {
            "item_name": "Ibuprofen 400mg",
            "item_amount": 200.00,
            "item_rate": 20.00,
            "item_quantity": 10.0
          }
        ]
      }
    ],
    "total_item_count": 2
  }
}
```

---

## Error Handling

- **Invalid PDF URL** → Returns `is_success: false` with error message
- **Timeout** → Request timeout after 3 minutes (180 seconds)
- **OpenAI API Failure** → Fallback error response with `is_success: false`
- **Large File** → Automatically reduces DPI and uses memory-efficient loading
- **Corrupted PDF** → Tries multiple load strategies before failing

---

## Performance Considerations

- **Small bills** (< 5 MB): Standard DPI 300, fast extraction
- **Medium bills** (5–15 MB): Reduced DPI 200 to optimize performance
- **Large bills** (> 15 MB): Low DPI 150, memory-only loading to handle huge documents
- **Parallel processing**: Default 4 threads for batch processing
- **Batch size**: Default 3 pages per batch

All these can be tuned in `BillExtractionService` constants if needed.

---

## Support & Troubleshooting

**Q: API not responding**
- Check if service is running: `curl http://localhost:8080/health`
- Verify `OPENAI_API_KEY` and `OPENAI_API_URL` are set

**Q: "Failed to download PDF"**
- Ensure PDF URL is public and accessible
- Check network connectivity

**Q: Extraction takes too long**
- Reduce DPI for large files (adjust in config)
- Increase thread pool size (in `application.properties`)

**Q: Token usage is `null`**
- Currently, token tracking may not be enabled; this is on the roadmap

---

## License

This project is part of the BFHL Datathon 2025. All rights reserved.

---

## Authors

Developed as a bill extraction solution using Spring Boot, OpenAI GPT‑4.1 Vision, and Apache PDFBox.

---

**Last Updated:** November 30, 2025
